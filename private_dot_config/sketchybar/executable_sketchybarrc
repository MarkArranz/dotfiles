#!/usr/bin/env lua

local config_dir = os.getenv("HOME") .. "/.config/sketchybar"

-- Setup package paths
package.path = config_dir .. "/?.lua;" .. package.path
package.cpath = package.cpath .. ";" .. os.getenv("HOME") .. "/.local/share/sketchybar_lua/?.so"

-- Build the C helper (must complete before use, so use os.execute)
os.execute("(cd " .. config_dir .. "/helpers/event_provider && make) >/dev/null 2>&1")

-- Launch the CPU helper early using os.execute (not sbar.exec) so it starts
-- immediately as a real child process. This gives it time to register its Mach
-- service before sbar.end_config() tries to connect via the mach_helper property.
local colors = require("config.colors")
os.execute(string.format(
	"killall helper 2>/dev/null; RED=0x%x ORANGE=0x%x YELLOW=0x%x LABEL_COLOR=0x%x %s/helpers/event_provider/helper git.felix.helper &",
	colors.red,
	colors.orange,
	colors.yellow,
	colors.white,
	config_dir
))

-- Load sketchybar module
sbar = require("sketchybar")

-- Unload macOS volume overlay (async)
sbar.exec("launchctl unload -F /System/Library/LaunchAgents/com.apple.OSDUIHelper.plist >/dev/null 2>&1")

-- Bundle configuration into a single message
sbar.begin_config()
require("config.bar")
require("config.default")
require("items")
sbar.end_config()

-- Enable hot reload
sbar.hotload(true)

-- Run the event loop
sbar.event_loop()
