#!/usr/bin/env lua

local config_dir = os.getenv("HOME") .. "/.config/sketchybar"

-- Setup package paths
package.path = config_dir .. "/?.lua;" .. package.path
package.cpath = package.cpath .. ";/Users/" .. os.getenv("USER") .. "/.local/share/sketchybar_lua/?.so"

-- Build the C helper (must complete before use, so use os.execute)
os.execute("(cd " .. config_dir .. "/helper && make) >/dev/null 2>&1")

-- Load sketchybar module
sbar = require("sketchybar")

-- Unload macOS volume overlay (async)
sbar.exec("launchctl unload -F /System/Library/LaunchAgents/com.apple.OSDUIHelper.plist >/dev/null 2>&1")

-- Load colors and start the CPU helper with color environment variables (async)
local colors = require("config.colors")
local helper_cmd = string.format(
	"killall helper 2>/dev/null; RED=0x%x ORANGE=0x%x YELLOW=0x%x LABEL_COLOR=0x%x %s/helper/helper git.felix.helper",
	colors.red,
	colors.orange,
	colors.yellow,
	colors.white,
	config_dir
)
sbar.exec(helper_cmd)

-- Bundle configuration into a single message
sbar.begin_config()
require("config.bar")
require("config.default")
require("items")
sbar.end_config()

-- Enable hot reload
sbar.hotload(true)

-- Run the event loop
sbar.event_loop()
