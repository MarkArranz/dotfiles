#!/usr/bin/env bash
# Tuple dad-joke-greeter: room-joined trigger
#
# Fetches a random dad joke from icanhazdadjoke.com and speaks it aloud
# when someone joins a Tuple room. Audio is routed in parallel to both
# local speakers and BlackHole 2ch so remote Tuple participants hear it too.
#
# PREREQUISITE (one-time): Set Tuple's audio input to "BH + Mic Input"
#   Tuple > Preferences > Audio > Input Device > "BH + Mic Input"
#
# To disable temporarily without removing the trigger:
#   export TUPLE_DAD_JOKES_ENABLED=0
set -uo pipefail

BLACKHOLE_DEVICE="BlackHole 2ch"
SPEAKER_DEVICE="MacBook Pro Speakers"
API_URL="https://icanhazdadjoke.com/"

# Allow opt-out without removing the trigger file
if [[ "${TUPLE_DAD_JOKES_ENABLED:-1}" == "0" ]]; then
  exit 0
fi

# Fetch a random joke
joke=$(
  curl -sfS --connect-timeout 3 --max-time 3 \
    -H "Accept: application/json" \
    -H "User-Agent: TupleDadJokeGreeter/1.0" \
    "$API_URL" | jq -r '.joke // empty'
)

if [[ -z "$joke" ]]; then
  echo "$(date -Iseconds) [dad-joke-greeter] Failed to fetch joke" >&2
  exit 1
fi

# Sanitize joiner name to printable letters and spaces only (prevent injection)
raw_joiner="${TUPLE_TRIGGER_FULL_NAME:-someone}"
joiner="$(printf '%s' "$raw_joiner" | tr -cd '[:alpha:] ')"
joiner="${joiner:-someone}"

is_self="${TUPLE_TRIGGER_IS_SELF:-false}"

if [[ "$is_self" == "true" ]]; then
  greeting="Welcome to the room. Here is a dad joke."
else
  greeting="${joiner} just joined. Here is a dad joke."
fi

full_text="${greeting} ${joke}"

# Play to local speakers and BlackHole (Tuple's audio input) in parallel.
# Both use || true so a missing audio device never fails the trigger.
say -a "$SPEAKER_DEVICE" -- "$full_text" || true &
say -a "$BLACKHOLE_DEVICE" -- "$full_text" || true &
wait

echo "$(date -Iseconds) [dad-joke-greeter] Told joke to ${joiner}: ${joke}"
