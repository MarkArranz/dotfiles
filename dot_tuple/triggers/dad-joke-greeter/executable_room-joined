#!/usr/bin/env bash
# Tuple dad-joke-greeter: room-joined trigger
#
# Tracks room membership for rooms listed in ~/.tuple/tracked-rooms and
# tells a dad joke when someone joins the room we're in — but only when
# 2+ people are present.
#
# State layout:
#   ~/.tuple/tracked-rooms              — rooms to track (one name per line)
#   ~/.tuple/.state/my-room             — room we're currently in
#   ~/.tuple/.state/rooms/<room>/members — one email per line per room
#
# PREREQUISITE (one-time): Set Tuple's audio input to "BH + Mic Input"
#   Tuple > Preferences > Audio > Input Device > "BH + Mic Input"
#
# To disable temporarily without removing the trigger:
#   export TUPLE_DAD_JOKES_ENABLED=0
set -uo pipefail

BLACKHOLE_DEVICE="BlackHole 2ch"
SPEAKER_DEVICE="MacBook Pro Speakers"
API_URL="https://icanhazdadjoke.com/"
TRACKED_ROOMS_FILE="$HOME/.tuple/tracked-rooms"
STATE_DIR="$HOME/.tuple/.state"
MY_ROOM_FILE="$STATE_DIR/my-room"

# Allow opt-out without removing the trigger file
if [[ "${TUPLE_DAD_JOKES_ENABLED:-1}" == "0" ]]; then
  exit 0
fi

is_self="${TUPLE_TRIGGER_IS_SELF:-false}"
room_name="${TUPLE_TRIGGER_ROOM_NAME:-}"
joiner_email="${TUPLE_TRIGGER_EMAIL:-}"
my_email="${TUPLE_TRIGGER_CURRENT_USER_EMAIL:-}"

# Only proceed for tracked rooms
if [[ ! -f "$TRACKED_ROOMS_FILE" ]] || ! grep -qxF "$room_name" "$TRACKED_ROOMS_FILE"; then
  exit 0
fi

# Sanitize room name for use as a directory name
safe_room="$(printf '%s' "$room_name" | tr -cd '[:alnum:] _-' | tr ' ' '_')"
ROOM_DIR="$STATE_DIR/rooms/$safe_room"
MEMBERS_FILE="$ROOM_DIR/members"

mkdir -p "$ROOM_DIR"

# --- Track membership ---

email_to_add=""
if [[ "$is_self" == "true" ]]; then
  printf '%s' "$room_name" > "$MY_ROOM_FILE"
  email_to_add="$my_email"
else
  email_to_add="$joiner_email"
fi

if [[ -n "$email_to_add" ]]; then
  grep -qxF "$email_to_add" "$MEMBERS_FILE" 2>/dev/null || printf '%s\n' "$email_to_add" >> "$MEMBERS_FILE"
fi

# --- Decide whether to tell a joke ---

# Only tell jokes in the room we're in
if [[ ! -f "$MY_ROOM_FILE" ]]; then
  exit 0
fi
my_room=$(<"$MY_ROOM_FILE")
if [[ "$my_room" != "$room_name" ]]; then
  exit 0
fi

# Only tell a joke when there are at least 2 people in the room
member_count=0
if [[ -f "$MEMBERS_FILE" ]]; then
  member_count=$(wc -l < "$MEMBERS_FILE" | tr -d ' ')
fi
if [[ "$member_count" -lt 2 ]]; then
  exit 0
fi

# --- Fetch and tell the joke ---

joke=$(
  curl -sfS --connect-timeout 3 --max-time 3 \
    -H "Accept: application/json" \
    -H "User-Agent: TupleDadJokeGreeter/1.0" \
    "$API_URL" | jq -r '.joke // empty'
)

if [[ -z "$joke" ]]; then
  echo "$(date -Iseconds) [dad-joke-greeter] Failed to fetch joke" >&2
  exit 1
fi

# Sanitize joiner name to printable letters and spaces only (prevent injection)
raw_joiner="${TUPLE_TRIGGER_FULL_NAME:-someone}"
joiner="$(printf '%s' "$raw_joiner" | tr -cd '[:alpha:] ')"
joiner="${joiner:-someone}"

if [[ "$is_self" == "true" ]]; then
  greeting="Hi everyone. Here is a dad joke."
else
  greeting="${joiner} just joined. Here is a dad joke."
fi

full_text="${greeting} ${joke}"

# Play to local speakers and BlackHole (Tuple's audio input) in parallel.
# Both use || true so a missing audio device never fails the trigger.
say -a "$SPEAKER_DEVICE" -- "$full_text" || true &
say -a "$BLACKHOLE_DEVICE" -- "$full_text" || true &
wait

echo "$(date -Iseconds) [dad-joke-greeter] Told joke to ${joiner}: ${joke}"
